<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“Š æ‘¸é±¼æ•°æ®ä¸­å¿ƒ (LCç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- å¼•å…¥ LeanCloud SDK -->
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.0/dist/av-min.js"></script>
    <style>
        body { background-color: #1a1a2e; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; }
        .card { background-color: #16213e; border-radius: 16px; border: 1px solid #2a3b55; }
        .glass-effect { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="h-screen p-6 overflow-hidden flex flex-col">

    <!-- æ ‡é¢˜æ  -->
    <header class="flex justify-between items-center mb-6 px-4">
        <h1 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-amber-500">
            <i class="fas fa-chart-line mr-2"></i>å…¨å‘˜æ‘¸é±¼å®å†µç›‘æ§
        </h1>
        <div class="text-right">
            <p class="text-gray-400 text-sm">Live Data Stream (LeanCloud)</p>
            <div class="flex items-center gap-2 text-green-400 text-xs">
                <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> æ•°æ®åŒæ­¥ä¸­ (æ¯3såˆ·æ–°)
            </div>
        </div>
    </header>

    <!-- æ ¸å¿ƒå†…å®¹åŒº -->
    <div class="flex-1 grid grid-cols-12 gap-6">
        <div class="col-span-4 flex flex-col gap-4">
            <div class="card p-6 text-center bg-gradient-to-br from-purple-900 to-indigo-900 border-none shadow-lg">
                <p class="text-indigo-200 text-sm uppercase tracking-widest mb-1">ä»Šæ—¥å…¨å‘˜ç´¯è®¡</p>
                <div class="text-6xl font-mono font-bold text-white" id="totalCount">0</div>
                <p class="text-indigo-300 text-xs mt-2">æ¯å¿«ä¹æ°´</p>
            </div>
            <div class="card flex-1 p-4 overflow-hidden flex flex-col">
                <h3 class="text-gray-400 text-sm font-bold mb-4 uppercase"><i class="fas fa-history mr-2"></i>æœ€æ–°æ‰“å¡</h3>
                <div id="feedList" class="flex-1 overflow-y-auto space-y-3 pr-2">
                    <!-- åŠ¨æ€åˆ—è¡¨é¡¹ -->
                </div>
            </div>
        </div>
        <div class="col-span-8 flex flex-col gap-6">
            <div class="card p-6 flex-1 relative">
                <h3 class="text-gray-400 text-sm font-bold mb-2 uppercase absolute top-6 left-6">
                    <i class="fas fa-pie-chart mr-2"></i>å“ç‰Œåå¥½åˆ†å¸ƒ
                </h3>
                <div class="w-full h-full flex items-center justify-center">
                    <canvas id="brandChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- LeanCloud Logic -->
    <script>
        // ============================================================
        // ğŸ”´ è®²å¸ˆæ³¨æ„ï¼šè¯·åœ¨è¿™é‡Œæ›¿æ¢ä¸ºä½ çš„ LeanCloud é…ç½®ä¿¡æ¯ (éœ€ä¸å­¦å‘˜ç«¯ä¸€è‡´)
        // ============================================================
        const LC_CONFIG = {
            appId: "erfYQncVAuWBHo0dsyc82sWh-MdYXbMMI",
            appKey: "z7phvRItGIDs3mmiHx5XwGXb",
            serverURL: "https://erfyqncv.api.lncldglobal.com"
        };
        // ============================================================

        let chartInstance = null;
        let isConfigured = false;

        // åˆå§‹åŒ–
        try {
            if (LC_CONFIG.appId !== "YOUR_LEANCLOUD_APP_ID") {
                AV.init(LC_CONFIG);
                isConfigured = true;
                startPolling(); // å¼€å§‹è½®è¯¢æ•°æ®
            } else {
                alert("è¯·å…ˆé…ç½®ä»£ç ä¸­çš„ LeanCloud AppID å’Œ Key");
            }
        } catch (e) {
            console.error(e);
            alert("LeanCloud åˆå§‹åŒ–å¤±è´¥");
        }

        function startPolling() {
            // é¦–æ¬¡ç«‹å³åŠ è½½
            fetchData();
            // ä¹‹åæ¯ 3 ç§’åˆ·æ–°ä¸€æ¬¡
            setInterval(fetchData, 3000);
        }

        async function fetchData() {
            try {
                const query = new AV.Query('MilkTeaRecords');
                query.descending('createdAt'); // æŒ‰æ—¶é—´å€’åº
                query.limit(50); // å–æœ€æ–°çš„50æ¡
                
                const results = await query.find();
                
                // è½¬æ¢æ•°æ®æ ¼å¼
                const records = results.map(r => ({
                    ...r.attributes, // è·å–æ•°æ®å­—æ®µ
                    createdAt: r.createdAt // è·å–åˆ›å»ºæ—¶é—´
                }));

                updateDashboard(records);

            } catch (error) {
                console.error("æ•°æ®æ‹‰å–å¤±è´¥:", error);
            }
        }

        function updateDashboard(records) {
            // 1. æ›´æ–°æ€»æ•° (è¿™é‡Œç®€å•ç”¨ records.length æ¼”ç¤ºï¼Œå®é™…å¯æŸ¥è¯¢ count)
            // ä¸ºäº†æ¼”ç¤ºæ•ˆæœï¼Œå¦‚æœæ•°æ®å°‘äº50æ¡ï¼Œå°±æ˜¯çœŸå®æ€»æ•°ï¼›å¦‚æœè¶…è¿‡50æ¡ï¼Œè¿™é‡Œä»…æ˜¾ç¤º50+
            // å¦‚æœæƒ³è·å–çœŸå®æ€»æ•°ï¼Œå¯ä»¥ç”¨ AV.Query.count()ï¼Œä½†ä¸ºäº†çœè¯·æ±‚æ•°ï¼Œè¿™é‡Œç›´æ¥æ˜¾ç¤ºåˆ—è¡¨é•¿åº¦
            // æˆ–è€…ï¼šä½ å¯ä»¥å•ç‹¬å‘ä¸€ä¸ª count æŸ¥è¯¢ï¼Œä½†è¿™é‡Œä¸ºäº†ç®€å•ç›´æ¥æ˜¾ç¤º
            document.getElementById('totalCount').innerText = records.length;

            // 2. æ›´æ–°åˆ—è¡¨ (å–å‰10æ¡)
            const feedList = document.getElementById('feedList');
            feedList.innerHTML = '';
            
            records.slice(0, 10).forEach(rec => {
                const div = document.createElement('div');
                div.className = 'glass-effect p-3 rounded-lg flex items-center justify-between fade-in border-l-4 border-pink-500';
                
                const userName = rec.username || "ç¥ç§˜èŒ¶å‹";
                const timeString = rec.createdAt ? rec.createdAt.toLocaleTimeString() : 'åˆšåˆš';

                div.innerHTML = `
                    <div class="flex flex-col">
                        <div class="text-xs text-indigo-300 font-bold mb-1 flex items-center">
                            <i class="fas fa-user-circle mr-1"></i> ${userName}
                        </div>
                        <div class="flex items-center">
                            <span class="text-base font-bold mr-2 text-white">${rec.brand.split(' ')[0]}</span>
                            <span class="text-gray-400 text-xs italic">${rec.mood}</span>
                        </div>
                    </div>
                    <span class="text-xs text-gray-500 ml-2 whitespace-nowrap">${timeString}</span>
                `;
                feedList.appendChild(div);
            });

            // 3. æ›´æ–°å›¾è¡¨
            updateChart(records);
        }

        function updateChart(records) {
            const counts = {};
            records.forEach(r => {
                const name = r.brand.split(' ')[0]; 
                counts[name] = (counts[name] || 0) + 1;
            });

            const labels = Object.keys(counts);
            const data = Object.values(counts);

            if (chartInstance) {
                chartInstance.data.labels = labels;
                chartInstance.data.datasets[0].data = data;
                chartInstance.update();
            } else {
                const ctx = document.getElementById('brandChart').getContext('2d');
                chartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'æ‰“å¡æ•°é‡',
                            data: data,
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.7)',
                                'rgba(54, 162, 235, 0.7)',
                                'rgba(255, 206, 86, 0.7)',
                                'rgba(75, 192, 192, 0.7)',
                                'rgba(153, 102, 255, 0.7)'
                            ],
                            borderColor: 'rgba(255, 255, 255, 0.5)',
                            borderWidth: 1,
                            borderRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, grid: { color: '#2a3b55' }, ticks: { color: '#a0aec0' } },
                            x: { grid: { display: false }, ticks: { color: '#a0aec0', font: {size: 14} } }
                        }
                    }
                });
            }
        }
    </script>
</body>
</html>